/*! This is GPL licensed code, see LICENSE/our website for more information.- v0.9.0-dev - 2013-12-19 */!function(a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(a):"undefined"!=typeof window?window.orgopenswpgp=a():"undefined"!=typeof global?global.orgopenswpgp=a():"undefined"!=typeof self&&(self.orgopenswpgp=a())}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a){var b=a("openpgp");org_open_sw_pgp=function(c,d){this.testMode=c?!0:!1,this.keyring=d?d:a("keyring"),b.util.print_output=function(a,c){if(!this.testMode){var d="UNKNOWN";switch(a){case b.util.printLevel.error:d="ERROR";break;case b.util.printLevel.warning:d="WARNING";break;case b.util.printLevel.info:d="INFO";break;case b.util.printLevel.debug:d="DEBUG"}try{console.log(d+": "+c)}catch(e){}}}},org_open_sw_pgp.prototype=new ZmZimletBase,org_open_sw_pgp.prototype.constructor=org_open_sw_pgp,org_open_sw_pgp.prototype.toString=function(){return"org_open_sw_pgp"},org_open_sw_pgp.prototype.init=function(){this.hasLocalStorage="object"==typeof window.localStorage},org_open_sw_pgp.prototype.onConvView=function(a,b,c){this.processMsg(a,c)},org_open_sw_pgp.prototype.onMsgView=function(a,b,c){this.processMsg(a,c)},org_open_sw_pgp.prototype.processMsg=function(a,b){var c=b._htmlElId+"__PGP-Zimlet",d=document.getElementById(c);if(d){var e=this.getFromTempCache(a.id);if(e)return d.innerHTML=e,void 0}a.getBodyPart(ZmMimeTable.TEXT_PLAIN,AjxCallback.simpleClosure(this.processMsgCB,this,b,d,a.id))},org_open_sw_pgp.prototype.processMsgCB=function(a,c,d,e){if(e){var f=e.getContent();if(f.match(/^-----BEGIN (.*)-----$/m)){if(!c){var g=document.getElementById(a._msgBodyDivId);c=document.createElement("div"),c.id=a._htmlElId+"__PGP-Zimlet",c.className="pgpInfoBar",g.parentElement.insertBefore(c,g),c=document.getElementById(c.id)}var h={divId:c.id,mailMsgId:d};h.cleartext=b.cleartext.readArmored(f),h.cleartext?this.verifyBar(h):this.resultBar(h,!1,"unknown","unknown","Error parsing message"),this.testMode&&this.searchForKey(h)}}},org_open_sw_pgp.prototype.destroyInfoBar=function(a){document.getElementById(a.divId).innerHTML="",this.removeFromTempCache(a.mailMsgId)},org_open_sw_pgp.prototype.searchForKey=function(a){a.keyList=[],a.keyIdList=[];for(var c=a.cleartext.getSigningKeyIds(),d=0;d<c.length;d++){var e=b.util.hexstrdump(c[d].write()),f=this.keyring.getKeysForKeyId(e);f&&f.length>0?a.keyList=a.keyList.concat(f):a.keyIdList.push(e)}if(a.keyList.length>0)this.msgVerify(a);else if(!this.testMode){var g=appCtxt.getYesNoMsgDialog(),h="Could not find public key in the cache, search pgp.mit.edu for it?",i=DwtMessageDialog.INFO_STYLE;g.setButtonListener(DwtDialog.YES_BUTTON,new AjxListener(this,this._searchBtnListener,a)),g.setButtonListener(DwtDialog.NO_BUTTON,new AjxListener(this,this._dialogCloseListener)),g.reset(),g.setMessage(h,i),g.popup()}},org_open_sw_pgp.prototype._searchBtnListener=function(a,b){b&&b.item.parent.popdown();var c=a.keyIdList[0],d=AjxRpc.invoke(null,"/service/zimlet/org_open_sw_pgp/lookup.jsp?key=0x"+c,null,null,!0);if(""!==d.text&&"No email specified"!==d.txt){var e=document.createElement("div");e.innerHTML=d.text;var f=e.getElementsByTagName("pre")[0].innerHTML;this.keyring.importKey(f),this.msgVerify(a)}else{var g=appCtxt.getYesNoMsgDialog(),h="Could not find the key on pgp.mit.edu, enter it manually?",i=DwtMessageDialog.INFO_STYLE;g.setButtonListener(DwtDialog.YES_BUTTON,new AjxListener(this,manualKeyEntry,a)),g.setButtonListener(DwtDialog.NO_BUTTON,new AjxListener(this,_dialogCloseListener)),g.reset(),g.setMessage(h,i),g.popup()}},org_open_sw_pgp.prototype.manualKeyEntry=function(a,b){b.item.parent.popdown();var c='<div id="keyEntryDiv"><textarea id="keyEntryTextarea"></textarea></div>',d='<center>Enter in the public key and press "OK"</center>',e=new DwtComposite(appCtxt.getShell());e.setSize("500","500"),e.getHtmlElement().style.overflow="auto",e.getHtmlElement().innerHTML=c;var f=new ZmDialog({title:d,view:e,parent:appCtxt.getShell(),standardButtons:[DwtDialog.OK_BUTTON]});f.setButtonListener(DwtDialog.OK_BUTTON,new AjxListener(this,this._readKeyListener,a)),f.popup()},org_open_sw_pgp.prototype._readKeyListener=function(a,b){b.item.parent.popdown();var c=document.getElementById("keyEntryTextarea").value;document.getElementById("keyEntryTextarea").value="",this.keyring.importKey(c),this.msgVerify(a)},org_open_sw_pgp.prototype.msgVerify=function(a){var c;if(0===a.keyList.length){var d=a.cleartext.getSigningKeyIds();for(c=0;c<d.length;c++){var e=this.keyring.getKeysForKeyId(b.util.hexstrdump(d[c].write()));null!==e&&e.length>0&&(a.keyList=a.keyList.concat(e))}}var f=!1,g="0x"+b.util.hexstrdump(a.keyList[0].getKeyIds()[0].write()).substring(8),h=a.keyList[0].getUserIds()[0],i=a.cleartext.verify(a.keyList);if(i)for(c=0;c<i.length;c++)if(i[c].valid){f=!0,g="0x"+b.util.hexstrdump(i[c].keyid.write()).substring(8),h=a.keyList[c].getUserIds()[0];break}this.resultBar(a,f,g,h)},org_open_sw_pgp.prototype.removeFromTempCache=function(a){this.hasLocalStorage?sessionStorage.removeItem(a):document.cookie.removeItem("PGPVerified_"+a)},org_open_sw_pgp.prototype.storeInTempCache=function(a,b){this.hasLocalStorage?sessionStorage.setItem(a,escape(b)):document.cookie="PGPVerified_"+a+"="+escape(b)},org_open_sw_pgp.prototype.getFromTempCache=function(a){if(this.hasLocalStorage)return msgHTML=sessionStorage.getItem(a),null!==msgHTML&&(msgHTML=unescape(msgHTML)),msgHTML;var b=document.cookie.split(";"),c=[];for(i=0;i<b.length;i++)-1!=b[i].indexOf("PGPVerified_")&&c.push(i);for(i=0;i<c.length;i++)if(b[c[i]].replace(/^\s/,"").split("=")[0]==="PGPVerified_"+a)return msgHTML=unescape(b[c[i]].replace(/^\s/,"").split("=")[1]);return null},org_open_sw_pgp.prototype.verifyBar=function(a){var b={logo:this.getResource("pgp.png"),infoBarDivId:a.divId},c=this,d=document.getElementById(a.divId);d.innerHTML=AjxTemplate.expand("org_open_sw_pgp.templates.pgp#infobar_verify",b),buttons=d.getElementsByClassName("verifyButton"),buttons[0].onclick=function(){c.searchForKey(a)},buttons=d.getElementsByClassName("escapeButton"),buttons[0].onclick=function(){c.destroyInfoBar(a)}},org_open_sw_pgp.prototype.resultBar=function(a,b,c,d,e){d=d.replace("<","&lt;").replace(">","&gt;"),e||(e=b?"verified successfully!":"*NOT* verified!");var f={logo:this.getResource("pgp.png"),className:b?"success":"fail",id:c,user:d,msg:e,infoBarDivId:a.divId},g=this,h=document.getElementById(a.divId);h.innerHTML=AjxTemplate.expand("org_open_sw_pgp.templates.pgp#infobar_result",f),buttons=h.getElementsByClassName("escapeButton"),buttons[0].onclick=function(){g.destroyInfoBar(a)}},org_open_sw_pgp.prototype._dialogCloseListener=function(a){a&&a.item.parent.popdown()}},{}]},{},[1])(1)});